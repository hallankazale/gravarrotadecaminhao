<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Rastreador de Rotas (Caminh√£o) ‚Äî Mobile</title>
  <meta name="theme-color" content="#22c55e">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    :root{ --bg:#0f172a; --fg:#e5e7eb; --muted:#94a3b8; --acc:#22c55e; --warn:#f59e0b; --err:#ef4444; --card:#111827 }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .wrap{display:flex;flex-direction:column;height:100%;gap:.75rem;padding:.75rem}
    header{display:flex;align-items:center;justify-content:space-between;gap:.5rem}
    h1{font-size:1.05rem;margin:0}
    .chip{font-size:.75rem;padding:.25rem .5rem;border-radius:999px;background:#334155}
    .cards{display:grid;grid-template-columns:1fr;gap:.75rem}
    @media (min-width:700px){.cards{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;box-shadow:0 8px 24px rgb(0 0 0 / .25);overflow:hidden}
    .card>.head{display:flex;align-items:center;justify-content:space-between;padding:.75rem .9rem;border-bottom:1px solid #1f2937}
    .head h2{font-size:.95rem;margin:0;color:#cbd5e1}
    .head small{color:var(--muted)}
    .body{padding:.75rem .9rem}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .metric{background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:.6rem}
    .metric .label{font-size:.75rem;color:var(--muted)}
    .metric .value{font-size:1.1rem;margin-top:.15rem}
    .controls{display:flex;flex-wrap:wrap;gap:.5rem}
    button{appearance:none;border:0;border-radius:12px;padding:.7rem .9rem;font-weight:600}
    .primary{background:var(--acc);color:#052e16}
    .secondary{background:#1f2937;color:#e5e7eb}
    .danger{background:var(--err);color:#fff}
    .warning{background:var(--warn);color:#111}
    .ghost{background:transparent;border:1px dashed #334155;color:#cbd5e1}
    button:disabled{opacity:.6}
    #map{height:55vh;width:100%}
    .log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.8rem;max-height:22vh;overflow:auto;background:#0b1220;border:1px solid #1f2937;border-radius:10px;padding:.6rem}
    .tag{display:inline-block;background:#0b1220;border:1px solid #1f2937;padding:.15rem .45rem;border-radius:8px;margin-right:.25rem}
    input,select{background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:10px;padding:.6rem;width:100%}
    details summary{cursor:pointer;color:#cbd5e1}
    .meta-row{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üìç Rastreador de Rotas do Caminh√£o</h1>
      <span id="statusChip" class="chip">Parado</span>
    </header>

    <section class="cards">
      <div class="card">
        <div class="head">
          <h2>Mapa & Trajeto</h2>
          <small id="gpsQuality">‚Äî</small>
        </div>
        <div class="body"><div id="map"></div></div>
      </div>

      <div class="card">
        <div class="head">
          <h2>Sess√£o atual</h2>
          <small id="startTimeLabel">‚Äî</small>
        </div>
        <div class="body">
          <div class="two-col">
            <div class="metric"><div class="label">Tempo</div><div id="mDuration" class="value">00:00:00</div></div>
            <div class="metric"><div class="label">Dist√¢ncia</div><div id="mDistance" class="value">0,00 km</div></div>
            <div class="metric"><div class="label">Velocidade m√©dia</div><div id="mAvgSpeed" class="value">0,0 km/h</div></div>
            <div class="metric"><div class="label">Velocidade m√°x.</div><div id="mMaxSpeed" class="value">0,0 km/h</div></div>
            <div class="metric"><div class="label">Tempo parado</div><div id="mIdle" class="value">00:00:00</div></div>
            <div class="metric"><div class="label">Pontos</div><div id="mPoints" class="value">0</div></div>
          </div>

          <div style="height:.6rem"></div>
          <div class="controls">
            <button id="btnStart" class="primary">‚ñ∂Ô∏è Iniciar</button>
            <button id="btnPause" class="warning" disabled>‚è∏Ô∏è Pausar</button>
            <button id="btnResume" class="secondary" disabled>‚ñ∂Ô∏è Retomar</button>
            <button id="btnStop" class="danger" disabled>‚èπÔ∏è Finalizar & Salvar</button>
            <button id="btnMark" class="ghost" disabled>üìç Marcar ponto</button>
          </div>

          <div style="height:.6rem"></div>
          <label>Nome da rota (opcional)</label>
          <input id="routeName" placeholder="Ex.: Entrega 24/09 ‚Äì Araquari ‚Üí Joinville" />

          <div style="height:.6rem"></div>
          <h3 style="margin:.2rem 0;font-size:.9rem;color:#cbd5e1">Par√¢metros do caminh√£o (salvos no aparelho)</h3>
          <div class="two-col">
            <input id="truckHeight" placeholder="Altura (m) ex.: 3.8"/>
            <input id="truckWeight" placeholder="Peso total (t) ex.: 23"/>
            <input id="truckAxles" placeholder="Eixos ex.: 3"/>
            <select id="truckHazmat"><option value="nao">Sem HAZMAT</option><option value="sim">Com HAZMAT</option></select>
          </div>
          <small class="tag">Dados guardados localmente (localStorage).</small>

          <div style="height:.6rem"></div>
          <details>
            <summary>‚öôÔ∏è Ajustes de rastreio</summary>
            <div class="two-col" style="margin-top:.5rem">
              <input id="cfgMaxAcc" type="number" step="1" placeholder="Precis√£o m√°x. (m) ‚Äî padr√£o 35">
              <input id="cfgMinStep" type="number" step="1" placeholder="M√≠n. deslocamento (m) ‚Äî padr√£o 6">
              <input id="cfgSmoothing" type="number" step="0.1" placeholder="Suaviza√ß√£o 0‚Äì1 ‚Äî padr√£o 0.2">
              <input id="cfgAutoPauseSpeed" type="number" step="0.1" placeholder="Auto-pausa abaixo de (km/h) ‚Äî padr√£o 2.0">
              <input id="cfgAutoPauseSec" type="number" step="1" placeholder="Auto-pausa ap√≥s (s) ‚Äî padr√£o 20">
              <input id="cfgAutoResumeStep" type="number" step="1" placeholder="Auto-retomar ao mover (m) ‚Äî padr√£o 12">
            </div>
            <small class="tag">Ajustes s√£o salvos automaticamente.</small>
          </details>

          <div style="height:.6rem"></div>
          <div class="meta-row">
            <small id="batteryInfo" class="tag">üîã ‚Äî</small>
            <small id="netInfo" class="tag">üåê ‚Äî</small>
            <small id="permInfo" class="tag">üîë ‚Äî</small>
          </div>
        </div>
      </div>
    </section>

    <div class="card">
      <div class="head">
        <h2>Hist√≥rico salvo no aparelho</h2>
        <small><span class="tag">localStorage</span></small>
      </div>
      <div class="body">
        <div class="controls" style="margin-bottom:.5rem">
          <button class="ghost" id="btnExportAll">üì¶ Exportar tudo (.zip)</button>
          <button class="ghost" id="btnWipe">üßπ Limpar tudo</button>
          <button class="ghost" id="btnRestore">üì• Restaurar backup (.zip)</button>
        </div>
        <input id="fileRestore" type="file" accept=".zip" style="display:none">
        <div id="history"></div>
      </div>
    </div>

    <div class="card">
      <div class="head"><h2>Console</h2><small>erros e eventos</small></div>
      <div class="body"><div id="log" class="log"></div></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // ===== SW registration =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').then(
          () => console.log('SW registrado'),
          (e) => console.warn('SW falhou', e)
        );
      });
    }

    // ===== HTTPS / localhost aviso =====
    (function(){
      const ok = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
      if(!ok){ alert('Para o GPS funcionar no celular, publique em HTTPS (GitHub Pages j√° √© https).'); }
    })();

    // ===== Polyfill crypto.randomUUID() =====
    if (!('crypto' in window) || !crypto.randomUUID) {
      window.crypto = window.crypto || {};
      crypto.randomUUID = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random()*16|0, v = c==='x' ? r : (r&0x3|0x8);
        return v.toString(16);
      });
    }

    // ===== Utils =====
    const $ = (sel)=>document.querySelector(sel);
    const log = (msg)=>{ const el=$('#log'); const t=new Date().toLocaleTimeString(); el.innerText = `[${t}] ${msg}\n` + el.innerText; };
    const fmtKm = m => (m/1000).toFixed(2).replace('.',',') + ' km';
    const fmtHms = (sec)=> new Date(sec*1000).toISOString().substring(11,19);
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const kmh = (mps)=> (mps??0)*3.6;

    function haversine(a,b){
      const toRad=d=>d*Math.PI/180, R=6371e3;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
      const s1=toRad(a.lat), s2=toRad(b.lat);
      const aa=Math.sin(dLat/2)**2 + Math.cos(s1)*Math.cos(s2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(aa));
    }

    // ===== Estado =====
    let watchId=null, tracking=false, paused=false, autoPaused=false;
    let points=[], startedAt=null, pausedAt=null, pausedAccum=0, idleAccum=0;
    let lastAccepted=null, maxSpeed=0;
    let idleStart=null;

    // ===== Config (persistida) =====
    const KEY='truck.tracks.v1';
    const KEY_TRUCK='truck.params.v1';
    const KEY_CFG='truck.cfg.v1';
    const KEY_RECOVERY='truck.recovery.v1';

    const defaultCfg = {
      maxAcc: 35,
      minStep: 6,
      smoothing: 0.2,
      autoPauseSpeed: 2.0,
      autoPauseSec: 20,
      autoResumeStep: 12
    };
    function loadCfg(){ return Object.assign({}, defaultCfg, JSON.parse(localStorage.getItem(KEY_CFG)||'{}')); }
    function saveCfg(cfg){ localStorage.setItem(KEY_CFG, JSON.stringify(cfg)); }
    let cfg = loadCfg();

    // ===== Mapa =====
    const map=L.map('map',{zoomControl:false});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'¬© OpenStreetMap'}).addTo(map);
    map.setView([-26.37, -48.74], 11);
    const path=L.polyline([], {color:'#22c55e', weight:5, opacity:.9}).addTo(map);
    const startMarker=L.circleMarker([0,0],{radius:6,color:'#22c55e',fill:true,fillOpacity:1});
    const truckIcon = (deg=0)=> L.divIcon({
      className:'truck-marker',
      html:`<div style="transform:rotate(${deg}deg);width:20px;height:20px;display:grid;place-items:center">
              <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M4 16h1a2 2 0 1 0 4 0h6a2 2 0 1 0 4 0h1v-4l-3-4h-4V6H4v10z" fill="#38bdf8"/>
              </svg>
            </div>`,
      iconSize:[20,20], iconAnchor:[10,10]
    });
    let liveMarker=L.marker([0,0], {icon:truckIcon(0)});

    // ===== UI =====
    const btnStart=$('#btnStart'), btnPause=$('#btnPause'), btnResume=$('#btnResume'), btnStop=$('#btnStop'), btnMark=$('#btnMark');
    const chip=$('#statusChip');
    function setChip(txt,color){ chip.textContent=txt; chip.style.background=color; }

    // ===== Truck params =====
    function loadTruckParams(){ return JSON.parse(localStorage.getItem(KEY_TRUCK)||'{}'); }
    function saveTruckParams(obj){ localStorage.setItem(KEY_TRUCK, JSON.stringify(obj)); }
    function bindTruckForm(){
      const p=loadTruckParams();
      $('#truckHeight').value=p.height||''; $('#truckWeight').value=p.weight||''; $('#truckAxles').value=p.axles||''; $('#truckHazmat').value=p.hazmat||'nao';
      const handler=()=>{ const obj={ height:$('#truckHeight').value, weight:$('#truckWeight').value, axles:$('#truckAxles').value, hazmat:$('#truckHazmat').value }; saveTruckParams(obj); };
      ['truckHeight','truckWeight','truckAxles','truckHazmat'].forEach(id=>$('#'+id).addEventListener('change', handler));
    }

    // ===== Config form =====
    function applyCfgToForm(){
      $('#cfgMaxAcc').value = cfg.maxAcc;
      $('#cfgMinStep').value = cfg.minStep;
      $('#cfgSmoothing').value = cfg.smoothing;
      $('#cfgAutoPauseSpeed').value = cfg.autoPauseSpeed;
      $('#cfgAutoPauseSec').value = cfg.autoPauseSec;
      $('#cfgAutoResumeStep').value = cfg.autoResumeStep;
    }
    function bindCfgForm(){
      const ids=['cfgMaxAcc','cfgMinStep','cfgSmoothing','cfgAutoPauseSpeed','cfgAutoPauseSec','cfgAutoResumeStep'];
      ids.forEach(id=>{
        $('#'+id).addEventListener('change', ()=>{
          cfg.maxAcc = Number($('#cfgMaxAcc').value)||defaultCfg.maxAcc;
          cfg.minStep = Number($('#cfgMinStep').value)||defaultCfg.minStep;
          cfg.smoothing = clamp(Number($('#cfgSmoothing').value),0,1);
          cfg.autoPauseSpeed = Number($('#cfgAutoPauseSpeed').value)||defaultCfg.autoPauseSpeed;
          cfg.autoPauseSec = Number($('#cfgAutoPauseSec').value)||defaultCfg.autoPauseSec;
          cfg.autoResumeStep = Number($('#cfgAutoResumeStep').value)||defaultCfg.autoResumeStep;
          saveCfg(cfg);
          log('‚öôÔ∏è Configura√ß√µes atualizadas');
        });
      });
      applyCfgToForm();
    }

    // ===== Persist√™ncia rotas =====
    const loadAll=()=>JSON.parse(localStorage.getItem(KEY)||'[]');
    const saveAll=(arr)=>localStorage.setItem(KEY, JSON.stringify(arr));
    function getById(id){ return loadAll().find(x=>x.id===id); }

    function renderHistory(){
      const cont=$('#history'); cont.innerHTML='';
      const data=loadAll();
      if(!data.length){ cont.innerHTML='<p style="color:var(--muted)">Nada salvo ainda.</p>'; return; }
      for(const rec of data){
        const div=document.createElement('div');
        div.style.cssText='border:1px solid #1f2937;border-radius:10px;padding:.6rem;margin:.4rem 0;background:#0b1220';
        const started=new Date(rec.startedAt).toLocaleString();
        const dist=fmtKm(rec.distanceM);
        const dur=fmtHms(rec.durationSec);
        const paramsStr = rec.params? ` ‚Ä¢ Truck: ${rec.params.axles||'?'} eixos, ${rec.params.weight||'?'} t, ${rec.params.height||'?'} m` : '';
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:.5rem;align-items:center;flex-wrap:wrap">
            <div>
              <div style="font-weight:700">${rec.name}</div>
              <div style="font-size:.8rem;color:var(--muted)">In√≠cio: ${started} ‚Ä¢ Dura√ß√£o: ${dur} ‚Ä¢ Dist√¢ncia: ${dist} ‚Ä¢ Pontos: ${rec.points.length}${paramsStr}</div>
            </div>
            <div style="display:flex;gap:.4rem;flex-wrap:wrap">
              <button class="secondary" onclick='preview("${rec.id}")'>üëÅÔ∏è Visualizar</button>
              <button class="ghost" onclick='downloadGeoJSON("${rec.id}")'>‚¨áÔ∏è GeoJSON</button>
              <button class="ghost" onclick='downloadGPX("${rec.id}")'>‚¨áÔ∏è GPX</button>
              <button class="ghost" onclick='downloadKML("${rec.id}")'>‚¨áÔ∏è KML</button>
              <button class="ghost" onclick='downloadCSV("${rec.id}")'>‚¨áÔ∏è CSV</button>
              <button class="primary" onclick='shareRoutePrompt("${rec.id}")'>üì§ Compartilhar</button>
              <button class="danger" onclick='del("${rec.id}")'>üóëÔ∏è Apagar</button>
            </div>
          </div>`;
        cont.appendChild(div);
      }
    }
    function del(id){ const all=loadAll().filter(x=>x.id!==id); saveAll(all); renderHistory(); log('üóëÔ∏è Rota removida'); }

    // ===== Nome de arquivo seguro =====
    function baseName(name){ return name.replace(/[^\p{L}\p{N}_-]+/gu,'_'); }

    // ===== Geradores de arquivos =====
    function buildGeoJSON(rec){
      return JSON.stringify({
        type:'FeatureCollection',
        features:[{
          type:'Feature',
          properties:{name:rec.name, startedAt:rec.startedAt, params:rec.params||null},
          geometry:{ type:'LineString', coordinates: rec.points.map(p=>[p.lng,p.lat]) }
        }]
      });
    }
    function buildGPX(rec){
      const wpt = rec.points.map(p=>`<trkpt lat="${p.lat}" lon="${p.lng}"><time>${new Date(p.ts).toISOString()}</time>${p.spd?`<extensions><speed>${p.spd}</speed></extensions>`:''}</trkpt>`).join('\n');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="Rastreador" xmlns="http://www.topografix.com/GPX/1/1">\n<trk><name>${rec.name}</name><trkseg>\n${wpt}\n</trkseg></trk>\n</gpx>`;
    }
    function buildKML(rec){
      const coords = rec.points.map(p=>`${p.lng},${p.lat},0`).join(' ');
      return `<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2"><Document><Placemark><name>${rec.name}</name><LineString><tessellate>1</tessellate><coordinates>${coords}</coordinates></LineString></Placemark></Document></kml>`;
    }
    function buildCSV(rec){
      const head='ts,lat,lng,speed,accuracy,heading,tag\n';
      const rows=rec.points.map(p=>[p.ts,p.lat,p.lng,p.spd??'',p.acc??'',p.hdg??'',p.tag??''].join(','));
      return head+rows.join('\n');
    }

    // ===== Download helpers =====
    function download(filename, text, mime='text/plain'){
      const a=document.createElement('a'); a.href=`data:${mime};charset=utf-8,`+encodeURIComponent(text); a.download=filename; a.click();
    }
    window.downloadGeoJSON=(id)=>{ const rec=getById(id); if(!rec) return;
      download(`${baseName(rec.name)}.geojson`, buildGeoJSON(rec), 'application/geo+json');
    };
    window.downloadGPX=(id)=>{ const rec=getById(id); if(!rec) return;
      download(`${baseName(rec.name)}.gpx`, buildGPX(rec), 'application/gpx+xml');
    };
    window.downloadKML=(id)=>{ const rec=getById(id); if(!rec) return;
      download(`${baseName(rec.name)}.kml`, buildKML(rec), 'application/vnd.google-earth.kml+xml');
    };
    window.downloadCSV=(id)=>{ const rec=getById(id); if(!rec) return;
      download(`${baseName(rec.name)}.csv`, buildCSV(rec), 'text/csv');
    };

    // ===== Compartilhar (Web Share API + fallback) =====
    async function shareBlob(filename, mime, content, summaryText){
      try{
        const file = new File([content], filename, {type:mime});
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ title: filename, text: summaryText, files: [file] });
          log('üì§ Compartilhado via Web Share API.');
          return true;
        }
        if (navigator.share) {
          await navigator.share({ title: filename, text: summaryText });
          log('üì§ Compartilhado (somente texto).');
          download(filename, content, mime);
          return true;
        }
      } catch (e){ /* cancelado, seguimos pro fallback */ }
      try{
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(summaryText);
          log('üìã Resumo copiado. Iniciando download do arquivo...');
        }
      } finally {
        download(filename, content, mime);
      }
      return false;
    }

    window.shareRoutePrompt=(id)=>{
      const rec=getById(id); if(!rec) return;
      const choice = prompt(
        `Compartilhar rota "${rec.name}" em qual formato?\n`+
        `1) GeoJSON (padr√£o GIS)\n`+
        `2) GPX (apps de trilha/GPS)\n`+
        `3) KML (Google Earth)\n`+
        `4) CSV (tabela)`
      );
      const opt = Number(choice);
      if (![1,2,3,4].includes(opt)) return;

      const started = new Date(rec.startedAt).toLocaleString();
      const distKm = (rec.distanceM/1000).toFixed(2).replace('.',